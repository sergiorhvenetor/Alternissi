{% extends "post/base.html" %}
{% load static %}

{% block title %}Detalle del Pedido {{ pedido.codigo }} - {{ block.super }}{% endblock %}

{% block header_banner %}
<section class="page-banner">
    <div class="container">
        <h1>Detalle del Pedido</h1>
    </div>
</section>
{% endblock %}

{% block extra_css %}
    {% include "post/cuenta/_account_styles.html" %}
    <style>
        .order-info { margin-bottom: 30px; padding: 20px; background: var(--color-light-gray); border-radius: 8px; }
        .order-info p { margin-bottom: 10px; }
        .order-items-table img { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; }
        .totals-summary { margin-top: 30px; max-width: 400px; margin-left: auto; }
        .summary-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--color-medium-gray); }
        .summary-row.grand-total { border-bottom: none; font-weight: 700; font-size: 1.2em; color: var(--color-dark-gray); padding-top: 15px; }
        .shipping-billing-info { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 40px; }
        .address-column h4 { margin-bottom: 15px; border-bottom: 2px solid var(--color-medium-gray); padding-bottom: 5px; }
        .action-buttons { margin-top: 40px; }
        @media (max-width: 576px) { .shipping-billing-info { grid-template-columns: 1fr; } }
    </style>
{% endblock %}

{% block content %}
<div class="account-container">
    <div class="account-grid">
        {% include "post/cuenta/_sidebar.html" with active_tab="pedidos" %}

        <main class="account-content">
            {% if pedido %}
                <h2>Pedido #{{ pedido.codigo }}</h2>

                <div class="order-info">
                    <p><strong>Fecha:</strong> {{ pedido.creado|date:"d F Y, H:i" }}</p>
                    <p><strong>Estado:</strong> {{ pedido.get_estado_display }}</p>
                    <p><strong>Método de Pago:</strong> {{ pedido.get_metodo_pago_display }}</p>
                    {% if pedido.transaccion_id %}<p><strong>ID Transacción:</strong> {{ pedido.transaccion_id }}</p>{% endif %}
                </div>

                <h3>Artículos</h3>
                <table class="order-items-table">
                    <thead>
                        <tr>
                            <th colspan="2">Producto</th>
                            <th>Cantidad</th>
                            <th>Precio</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in pedido.detalles.all %}
                        <tr>
                            <td style="width: 80px;">
                                {% if item.producto.imagenes.first %}
                                    <img src="{{ item.producto.imagenes.first.imagen.url }}" alt="{{ item.producto.nombre }}">
                                {% else %}
                                    <img src="{% static 'post/images/placeholder.png' %}" alt="N/A">
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ item.producto.get_absolute_url }}">{{ item.producto.nombre }}</a>
                            </td>
                            <td>{{ item.cantidad }}</td>
                            <td>{{ item.precio|floatformat:2 }} {{moneda_simbolo|default:'$'}}</td>
                            <td>{{ item.subtotal|floatformat:2 }} {{moneda_simbolo|default:'$'}}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <div class="totals-summary">
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span>{{ pedido.subtotal|floatformat:2 }} {{moneda_simbolo|default:'$'}}</span>
                    </div>
                    {% if pedido.descuento > 0 %}
                    <div class="summary-row">
                        <span>Descuento:</span>
                        <span>- {{ pedido.descuento|floatformat:2 }} {{moneda_simbolo|default:'$'}}</span>
                    </div>
                    {% endif %}
                    {% if pedido.envio > 0 %}
                    <div class="summary-row">
                        <span>Envío:</span>
                        <span>{{ pedido.envio|floatformat:2 }} {{moneda_simbolo|default:'$'}}</span>
                    </div>
                    {% endif %}
                    <div class="summary-row grand-total">
                        <span>Total:</span>
                        <span>{{ pedido.total|floatformat:2 }} {{moneda_simbolo|default:'$'}}</span>
                    </div>
                </div>

                <div class="shipping-billing-info">
                    <div class="address-column">
                        <h4>Envío</h4>
                        <address>
                            {{ pedido.direccion_envio.nombre }} {{ pedido.direccion_envio.apellido }}<br>
                            {{ pedido.direccion_envio.direccion1 }}<br>
                            {% if pedido.direccion_envio.direccion2 %}{{ pedido.direccion_envio.direccion2 }}<br>{% endif %}
                            {{ pedido.direccion_envio.ciudad }}, {{ pedido.direccion_envio.codigo_postal }}<br>
                            {{ pedido.direccion_envio.pais }}
                        </address>
                    </div>
                    <div class="address-column">
                        <h4>Facturación</h4>
                         <address>
                            {{ pedido.direccion_facturacion.nombre }} {{ pedido.direccion_facturacion.apellido }}<br>
                            {{ pedido.direccion_facturacion.direccion1 }}<br>
                            {{ pedido.direccion_facturacion.ciudad }}, {{ pedido.direccion_facturacion.codigo_postal }}<br>
                            {{ pedido.direccion_facturacion.pais }}
                        </address>
                    </div>
                </div>

                <div class="form-actions">
                    <a href="{% url 'tienda:lista_pedidos_cliente' %}" class="btn btn-secondary">
                        Volver a Mis Pedidos
                    </a>
                </div>
            {% else %}
                <p>No se pudo cargar la información del pedido.</p>
            {% endif %}
        </main>
    </div>
</div>
{% endblock %}
