{% extends "post/base.html" %}
{% load static %}

{% block title %}Tu Carrito de Compras - {{ block.super }}{% endblock %}

{% block extra_head %}
<style>
    .cart-container { max-width: 1000px; margin: 20px auto; padding: 20px; }
    .cart-container h1 { text-align: center; margin-bottom: 30px; font-size: 2.2em;}
    .cart-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
    .cart-table th, .cart-table td { border: 1px solid #ddd; padding: 12px; text-align: left; vertical-align: middle; }
    .cart-table th { background-color: #f8f9fa; font-weight: bold; }
    .cart-table img { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; margin-right:10px; }
    .cart-table .product-name a { text-decoration: none; color: #007bff; }
    .cart-table .product-name a:hover { text-decoration: underline; }
    .cart-table input[type="number"] { width: 60px; padding: 5px; text-align: center; border: 1px solid #ccc; border-radius:3px;}
    .cart-table .btn-update-item, .cart-table .btn-remove-item {
        padding: 6px 10px; font-size: 0.9em; cursor: pointer; border:none; border-radius:4px; text-decoration:none; display:inline-block;
    }
    /* .btn-update-item ya no se usa directamente, se maneja con JS onchange */
    .cart-table .btn-remove-item { background-color: #dc3545; color: white; }

    .cart-summary-actions-wrapper { display: flex; gap: 20px; flex-wrap:wrap; align-items: flex-start;}
    .coupon-area {flex:1; min-width:280px; background-color: #f8f9fa; padding: 20px; border-radius: 5px;}
    .coupon-area h2 { font-size: 1.5em; margin-top: 0; margin-bottom: 15px; border-bottom:1px solid #eee; padding-bottom:10px; }
    .cart-summary { background-color: #f8f9fa; padding: 20px; border-radius: 5px; flex:1.5; min-width:300px;}
    .cart-summary h2 { font-size: 1.5em; margin-top: 0; margin-bottom: 15px; border-bottom:1px solid #eee; padding-bottom:10px; }
    .summary-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 1.1em; }
    .summary-row.total { font-weight: bold; font-size: 1.3em; margin-top:15px; padding-top:10px; border-top:1px solid #ccc;}
    .coupon-form { margin-top: 15px; display: flex; gap: 10px; }
    .coupon-form input[type="text"] { flex-grow: 1; padding: 8px; border:1px solid #ccc; border-radius:4px; }
    .coupon-form button { padding: 8px 15px; background-color: #5a6268; color:white; border:none; border-radius:4px; cursor:pointer; }
    .applied-coupon { color: green; margin-top:10px; font-weight:bold; }

    .cart-actions { text-align: right; }
    .cart-actions .btn { padding: 12px 25px; text-decoration: none; border-radius: 5px; font-size: 1.1em; margin-left: 15px; display:inline-block; margin-top:20px;}
    .cart-actions .btn-continue-shopping { background-color: #6c757d; color: white; }
    .cart-actions .btn-checkout { background-color: #28a745; color: white; }

    .empty-cart { text-align: center; padding: 40px 20px; background-color: #f0f0f0; border-radius: 5px; margin-top:20px; }
    .empty-cart h2 { font-size: 1.8em; margin-bottom:15px; }
    .empty-cart p { font-size: 1.1em; margin-bottom:20px; }
    .empty-cart .btn-primary { background-color: #007bff; color:white; padding:10px 20px; text-decoration:none; border-radius:5px;}
</style>
{% endblock %}

{% block content %}
<div class="cart-container">
    <h1>Tu Carrito de Compras</h1>

    {% if carrito and carrito.items.all %}
        {# No se necesita un form global si cada acción tiene su propio form/link o es AJAX #}
            <table class="cart-table">
                <thead>
                    <tr>
                        <th colspan="2">Producto</th>
                        <th>Precio Unitario</th>
                        <th>Cantidad</th>
                        <th>Subtotal</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in carrito.items.all %} {# Asume items están prefetched con producto e imagenes #}
                    <tr>
                        <td>
                            <a href="{{ item.producto.get_absolute_url }}">
                                {% if item.producto.imagenes.first %}
                                    <img src="{{ item.producto.imagenes.first.imagen.url }}" alt="{{ item.producto.nombre }}">
                                {% else %}
                                    <img src="{% static 'post/images/placeholder.png' %}" alt="Imagen no disponible">
                                {% endif %}
                            </a>
                        </td>
                        <td class="product-name">
                            <a href="{{ item.producto.get_absolute_url }}">{{ item.producto.nombre }}</a>
                            <p style="font-size:0.85em; color:#666;">SKU: {{ item.producto.sku }}</p>
                        </td>
                        <td>{{ item.precio|floatformat:2 }} {{moneda_simbolo|default:'$'}}</td>
                        <td>
                            <input type="number" name="cantidad" value="{{ item.cantidad }}" min="1"
                                   max="{{ item.producto.stock }}" data-item-id="{{ item.id }}"
                                   onchange="updateCartItem('{% url 'tienda:actualizar_item_carrito' item_id=0 %}'.replace('0', this.dataset.itemId), this.dataset.itemId, this.value, this)">
                                   {# URL se construye dinámicamente para evitar error si item.id es None en template parsing inicial #}
                        </td>
                        <td id="subtotal-{{ item.id }}">{{ item.subtotal|floatformat:2 }} {{moneda_simbolo|default:'$'}}</td>
                        <td>
                            <form action="{% url 'tienda:eliminar_item_carrito' item_id=item.id %}" method="post" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn-remove-item"
                                        onclick="return confirm('¿Estás seguro de que quieres eliminar este producto del carrito?');">Eliminar</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

        <div class="cart-summary-actions-wrapper">
            <div class="coupon-area">
                <h2>Aplicar Cupón</h2>
                <form action="{% url 'tienda:aplicar_cupon' %}" method="post" class="coupon-form">
                    {% csrf_token %}
                    <input type="text" name="codigo" placeholder="Ingresa tu código de cupón" {% if carrito.cupon %}value="{{ carrito.cupon.codigo }}" readonly{% endif %}>
                    <button type="submit" {% if carrito.cupon %}disabled title="Ya hay un cupón aplicado. Elimínalo para aplicar otro."{% endif %}>Aplicar</button>
                </form>
                {% if carrito.cupon %}
                    <p class="applied-coupon">Cupón aplicado: {{ carrito.cupon.codigo }}
                        {# Podríamos añadir un botón para quitar el cupón #}
                    </p>
                {% endif %}
            </div>

            <div class="cart-summary">
                <h2>Resumen del Pedido</h2>
                <div class="summary-row">
                    <span>Subtotal (<span id="cart-total-items">{{ carrito.total_items|default:0 }}</span> items):</span>
                    <span id="cart-subtotal">{{ carrito.subtotal|floatformat:2 }} {{moneda_simbolo|default:'$'}}</span>
                </div>
                
                <div class="summary-row" id="cart-discount-row">
                    <span>Descuento ({{ carrito.cupon.codigo }}):</span>
                    
                </div>
                {% else %}
                {# Fila de descuento oculta si no hay descuento inicialmente #}
                <div class="summary-row" id="cart-discount-row" style="display: none;">
                    <span>Descuento (<span id="cart-cupon-code-display"></span>):</span> {# Para mostrar el código del cupón dinámicamente #}
                    <span id="cart-discount-amount"></span>
                </div>
                {% endif %}
                <div class="summary-row total">
                    <span>Total:</span>
                    <span id="cart-total">{{ carrito.total|floatformat:2 }} {{moneda_simbolo|default:'$'}}</span>
                </div>
            </div>
        </div>

        <div class="cart-actions">
            <a href="{% url 'tienda:lista_productos' %}" class="btn btn-continue-shopping">Continuar Comprando</a>
            <a href="{% url 'tienda:checkout' %}" class="btn btn-checkout">Proceder al Pago</a>
        </div>


        <div class="empty-cart">
            <h2>Tu carrito está vacío.</h2>
            <p>Parece que no has añadido ningún producto a tu carrito todavía.</p>
            <a href="{% url 'tienda:lista_productos' %}" class="btn btn-primary">Explorar Productos</a>
        </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
function updateCartItem(url, itemId, quantity, inputElement) {
    const csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]').value;
    const originalQuantity = inputElement.defaultValue;
    const monedaSimbolo = "{{ moneda_simbolo|default:'$' }}"; // Obtener el símbolo de moneda del contexto

    // Deshabilitar el input mientras se procesa para evitar múltiples envíos
    inputElement.disabled = true;

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken
        },
        body: `cantidad=${quantity}`
    })
    .then(response => {
        if (!response.ok) {
            // Si el servidor devuelve un error (4xx, 5xx), intenta parsear el JSON del error.
            return response.json().then(errData => Promise.reject(errData));
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            if (data.removed) {
                // Eliminar la fila del item de la tabla
                inputElement.closest('tr').remove();
            } else {
                // Actualizar subtotal del item
                const itemSubtotalEl = document.getElementById(`subtotal-${itemId}`);
                if (itemSubtotalEl) {
                    itemSubtotalEl.textContent = parseFloat(data.item_subtotal).toFixed(2) + " " + monedaSimbolo;
                }
                inputElement.defaultValue = quantity; // Actualizar el valor original si es exitoso
            }

            // Actualizar totales del carrito
            const cartSubtotalEl = document.getElementById('cart-subtotal');
            if (cartSubtotalEl) {
                cartSubtotalEl.textContent = parseFloat(data.cart_subtotal_display).toFixed(2) + " " + monedaSimbolo;
            }
            const cartTotalEl = document.getElementById('cart-total');
            if (cartTotalEl) {
                cartTotalEl.textContent = parseFloat(data.cart_total_display).toFixed(2) + " " + monedaSimbolo;
            }
            const cartTotalItemsEl = document.getElementById('cart-total-items');
            if (cartTotalItemsEl) {
                cartTotalItemsEl.textContent = data.cart_total_items_display;
            }

            // Actualizar contador en la navbar
            const navbarCartCountEl = document.getElementById('cart-count');
            if (navbarCartCountEl) {
                navbarCartCountEl.textContent = data.cart_total_items_display;
            }

            // Manejar la fila de descuento
            const discountRowEl = document.getElementById('cart-discount-row');
            const discountAmountEl = document.getElementById('cart-discount-amount');
            const cuponCodeDisplayEl = document.getElementById('cart-cupon-code-display');

            if (data.cart_discount_amount_display && parseFloat(data.cart_discount_amount_display) > 0) {
                if (discountAmountEl) {
                    discountAmountEl.textContent = "- " + parseFloat(data.cart_discount_amount_display).toFixed(2) + " " + monedaSimbolo;
                }
                if (cuponCodeDisplayEl && data.cart_cupon_codigo) {
                     cuponCodeDisplayEl.textContent = data.cart_cupon_codigo;
                } else if (cuponCodeDisplayEl) {
                     cuponCodeDisplayEl.textContent = ''; // Limpiar si no hay código
                }
                if (discountRowEl) {
                    discountRowEl.style.display = 'flex'; // O el display original que tuviera
                }
            } else {
                if (discountRowEl) {
                    discountRowEl.style.display = 'none';
                }
            }

            if (data.cart_total_items_display === 0) {
                // Si el carrito queda vacío, recargar la página para mostrar el estado "carrito vacío".
                window.location.reload();
            }

        } else {
            alert('Error al actualizar el carrito: ' + (data.message || 'Error desconocido'));
            inputElement.value = originalQuantity; // Revertir al valor original
        }
    })
    .catch(error => {
        let errorMsg = 'Hubo un error al conectar con el servidor.';
        if (error && error.message) {
            errorMsg = error.message;
        } else if (typeof error === 'string') {
            errorMsg = error;
        }
        console.error('Error en AJAX:', error);
        alert(errorMsg);
        inputElement.value = originalQuantity;
    })
    .finally(() => {
        inputElement.disabled = false;
    });
}
</script>
{% endblock %}
