{% extends "post/base.html" %}
{% load static %}
{% load humanize %}

{% block title %}{{ producto.nombre }} - Alternissi{% endblock %}

{% block extra_head %}
{{ block.super }}
<!-- Incluir CDN para Material Icons si se usa para el corazón y stock -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="stylesheet" href="{% static 'post/css/detalle_producto.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'tienda:inicio' %}">Inicio</a></li>
            <li class="breadcrumb-item"><a href="{% url 'tienda:lista_productos' %}">Productos</a></li>
            {% if producto.categoria %}
            <li class="breadcrumb-item"><a href="{{ producto.categoria.get_absolute_url }}">{{ producto.categoria.nombre }}</a></li>
            {% endif %}
            <li class="breadcrumb-item active" aria-current="page">{{ producto.nombre }}</li>
        </ol>
    </nav>

    <div class="product-detail-layout">
        <div class="product-detail__image-gallery">
            <div class="main-image">
                {% if producto.imagenes.first %}
                    <img src="{{ producto.imagenes.first.imagen.url }}" alt="{{ producto.imagenes.first.alt_text|default:producto.nombre }}" id="mainProductImage">
                {% else %}
                    <img src="{% static 'post/images/placeholder.png' %}" alt="Imagen no disponible" id="mainProductImage">
                {% endif %}
            </div>
            {% if producto.imagenes.all|length > 1 %}
            <div class="thumbnail-images">
                {% for imagen_obj in producto.imagenes.all %}
                    <img src="{{ imagen_obj.imagen.url }}" alt="{{ imagen_obj.alt_text|default:producto.nombre }}"
                         onclick="changeMainImage('{{ imagen_obj.imagen.url }}', this)"
                         class="{% if forloop.first %}active-thumbnail{% endif %}">
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <div class="product-detail__info">
            <h1>{{ producto.nombre }}</h1>

            <div class="product-detail__meta">
                {% if producto.categoria %}
                    <span>Categoría: <a href="{{ producto.categoria.get_absolute_url }}">{{ producto.categoria.nombre }}</a></span>
                {% endif %}
                {% if producto.marca %}
                    <span>Marca: <a href="{% url 'tienda:productos_por_marca' marca_slug=producto.marca.slug %}">{{ producto.marca.nombre }}</a></span>
                {% endif %}
                {% if producto.sku %}
                    <span>SKU: {{ producto.sku }}</span>
                {% endif %}
            </div>

            <p class="product-detail__price">
                {% if producto.tiene_descuento %}
                    <span>${{ producto.precio_actual|floatformat:2 }}</span>
                    <span class="original-price">${{ producto.precio|floatformat:2 }}</span>
                    {% if producto.porcentaje_descuento > 0 %}
                        <span class="discount-badge">{{ producto.porcentaje_descuento|floatformat:0 }}% OFF</span>
                    {% endif %}
                {% else %}
                    <span>${{ producto.precio_actual|floatformat:2 }}</span>
                {% endif %}
            </p>

            <p class="stock-info {% if producto.stock > 0 and producto.disponible %}disponible{% else %}agotado{% endif %}">
                {% if producto.stock > 0 and producto.disponible %}
                    <span class="material-icons">check_circle</span> Disponible ({{ producto.stock }} en stock)
                {% else %}
                    <span class="material-icons">cancel</span> Agotado
                {% endif %}
            </p>

            <div class="product-detail__description">
                {# Mostrar descripción corta aquí, la larga irá en la pestaña #}
                <p>{{ producto.descripcion|linebreaksbr }}</p>
            </div>

            {% if producto.stock > 0 and producto.disponible %}
            <div class="product-detail__actions">
                <form action="{% url 'tienda:agregar_al_carrito' producto_id=producto.id %}" method="post">
                    {% csrf_token %}
                    <label for="cantidad">Cantidad:</label>
                    <input type="number" name="cantidad" id="cantidad" value="1" min="1" max="{{ producto.stock }}" aria-label="Cantidad">
                    <button type="submit" class="btn btn-primary"><span class="material-icons">add_shopping_cart</span>Añadir al Carrito</button>
                </form>
                <a href="{% url 'tienda:agregar_a_lista_deseos' producto_id=producto.id %}" class="wishlist-btn" title="Añadir a Lista de Deseos">
                    <span class="material-icons">favorite_border</span> <span class="d-none d-md-inline">Añadir a Deseos</span>
                </a>
            </div>
            {% else %}
                 <p class="text-danger lead">Este producto no está disponible actualmente.</p>
                 <a href="{% url 'tienda:agregar_a_lista_deseos' producto_id=producto.id %}" class="wishlist-btn mt-2" title="Añadir a Lista de Deseos">
                     <span class="material-icons">favorite_border</span> <span class="d-none d-md-inline">Notificarme si vuelve</span>
                 </a>
            {% endif %}
        </div>
    </div>

    <!-- Pestañas para Descripción Detallada, Especificaciones, Reseñas -->
    <div class="product-tabs-section">
        <ul class="nav nav-tabs" id="productTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="descripcion-tab" data-bs-toggle="tab" data-bs-target="#descripcionContent" type="button" role="tab" aria-controls="descripcionContent" aria-selected="true">Descripción Detallada</button>
            </li>
            {% if producto.caracteristicas %}
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="especificaciones-tab" data-bs-toggle="tab" data-bs-target="#especificacionesContent" type="button" role="tab" aria-controls="especificacionesContent" aria-selected="false">Características</button>
            </li>
            {% endif %}
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="reseñas-tab" data-bs-toggle="tab" data-bs-target="#reseñasContent" type="button" role="tab" aria-controls="reseñasContent" aria-selected="false">Reseñas ({{ resenas.count }})</button>
            </li>
        </ul>
        <div class="tab-content" id="productTabContent">
            <div class="tab-pane fade show active" id="descripcionContent" role="tabpanel" aria-labelledby="descripcion-tab">
                {{ producto.descripcion_larga|default:producto.descripcion|linebreaksbr|default:"No hay descripción detallada disponible para este producto." }}
            </div>
            {% if producto.caracteristicas %}
            <div class="tab-pane fade" id="especificacionesContent" role="tabpanel" aria-labelledby="especificaciones-tab">
                <ul class="list-unstyled">
                {% for key, value in producto.caracteristicas.items %}
                    <li><strong>{{ key|capfirst }}:</strong> {{ value }}</li>
                {% endfor %}
                </ul>
            </div>
            {% endif %}
            <div class="tab-pane fade reviews-section" id="reseñasContent" role="tabpanel" aria-labelledby="reseñas-tab">
                <h4>Reseñas de Clientes</h4>
                {% if resenas %}
                    {% for resena in resenas %}
                        <div class="review">
                            <p class="review-title">{{ resena.titulo }}</p>
                            <p class="rating">
                                {% for i in "x"|rjust:resena.calificacion %}★{% endfor %}{% for i in "x"|rjust:resena.calificacion_restante %}☆{% endfor %}
                                <span class="ms-2">({{ resena.calificacion }}/5)</span>
                            </p>
                            <p class="review-comment">{{ resena.comentario|linebreaksbr }}</p>
                            <p class="author">- {{ resena.cliente.usuario.get_full_name|default:resena.cliente.usuario.username }} el {{ resena.creado|date:"d M, Y" }}</p>
                             {% if resena.respuesta %}
                                <div class="review-reply" style="margin-left: 20px; padding-left:15px; border-left: 2px solid #eee; margin-top:10px;">
                                    <strong>Respuesta de la tienda:</strong>
                                    <p>{{ resena.respuesta|linebreaks }}</p>
                                    <p class="review-date">Fecha: {{ resena.respuesta_fecha|date:"d M Y" }}</p>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="no-reviews">Aún no hay reseñas para este producto. ¡Sé el primero en escribir una!</p>
                {% endif %}
                {% if user.is_authenticated %}
                    <a href="{% url 'tienda:crear_resena' producto_id=producto.id %}" class="btn btn-outline-primary add-review-link">Escribir una Reseña</a>
                {% else %}
                    <p class="mt-3"><a href="{% url 'tienda:login' %}?next={{ request.path }}">Inicia sesión</a> para escribir una reseña.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Productos Relacionados/Sugeridos -->
    {% if productos_relacionados %}
    <div class="related-products-section">
        <h3>También te podría interesar</h3>
        <div class="product-grid">
            {% for p_rel in productos_relacionados|slice:":4" %}
                {% include "post/includes/product_card.html" with producto=p_rel %}
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
{{ block.super }}
<!-- Bootstrap JS ya debería estar en base.html -->
<script src="{% static 'post/js/detalle_producto.js' %}"></script>
{% endblock %}
